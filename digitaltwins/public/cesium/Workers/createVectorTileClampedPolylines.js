import{a as e}from"./chunk-PWAJ3RAI.js";import{a as t}from"./chunk-CXNPIJLB.js";import{a as r}from"./chunk-NNHN6WUY.js";import{c as s,h as a}from"./chunk-YWRPWWKI.js";import"./chunk-VTVHUB7E.js";import{a as n,b as i,d as o}from"./chunk-JMSSU44E.js";import{a as l}from"./chunk-4UYSGV57.js";import"./chunk-ANLJ4KBN.js";import"./chunk-ID6SFQTL.js";import"./chunk-VLPNAR64.js";import"./chunk-GE5NEIZC.js";import"./chunk-35CVRQTC.js";var d=Math.cos(l.toRadians(150)),f=new i,h=new n,c=new i,u=new i;function p(e){let t=8*e,s=3*t,a=4*t;this.startEllipsoidNormals=new Float32Array(s),this.endEllipsoidNormals=new Float32Array(s),this.startPositionAndHeights=new Float32Array(a),this.startFaceNormalAndVertexCornerIds=new Float32Array(a),this.endPositionAndHeights=new Float32Array(a),this.endFaceNormalAndHalfWidths=new Float32Array(a),this.vertexBatchIds=new Uint16Array(t),this.indices=r.createTypedArray(t,36*e),this.vec3Offset=0,this.vec4Offset=0,this.batchIdOffset=0,this.indexOffset=0,this.volumeStartIndex=0}var m=new n,A=new n;function w(e,t,r,s,a){let i=n.subtract(r,t,A),o=n.subtract(t,e,m);return n.normalize(i,i),n.normalize(o,o),n.dot(i,o)<d&&(o=n.multiplyByScalar(o,-1,m)),n.add(i,o,a),n.equals(a,n.ZERO)&&(a=n.subtract(e,t)),n.cross(a,s,a),n.cross(s,a,a),n.normalize(a,a),a}var N=[0,2,6,0,6,4,0,1,3,0,3,2,0,4,5,0,5,1,5,3,1,5,7,3,7,5,4,7,4,6,7,6,2,7,2,3],k=N.length,b=new n,g=new n,y=new n,I=new n,E=new n;p.prototype.addVolume=function(e,t,r,s,a,i,o,l,d,f){let h=n.add(t,d,b),c=f.geodeticSurfaceNormal(h,g);h=n.add(r,d,b);let u=f.geodeticSurfaceNormal(h,I),p=w(e,t,r,c,y),m=w(s,r,t,u,E),A=this.startEllipsoidNormals,F=this.endEllipsoidNormals,x=this.startPositionAndHeights,v=this.startFaceNormalAndVertexCornerIds,H=this.endPositionAndHeights,P=this.endFaceNormalAndHalfWidths,O=this.vertexBatchIds,S=this.batchIdOffset,U=this.vec3Offset,V=this.vec4Offset,j;for(j=0;j<8;j++)n.pack(c,A,U),n.pack(u,F,U),n.pack(t,x,V),x[V+3]=a,n.pack(r,H,V),H[V+3]=i,n.pack(p,v,V),v[V+3]=j,n.pack(m,P,V),P[V+3]=o,O[S++]=l,U+=3,V+=4;this.batchIdOffset=S,this.vec3Offset=U,this.vec4Offset=V;let B=this.indices,C=this.volumeStartIndex,W=this.indexOffset;for(j=0;j<k;j++)B[W+j]=N[j]+C;this.volumeStartIndex+=8,this.indexOffset+=k};var F=new a,x=new o,v=new n,H=new n,P=new n,O=new n,S=new n,U=e(function(e,d){let m=new Uint16Array(e.positions),A=new Uint16Array(e.widths),w=new Uint32Array(e.counts),N=new Uint16Array(e.batchIds),k=new Float64Array(e.packedBuffer),b=0,g=k[b++],y=k[b++];a.unpack(k,b,F),b+=a.packedLength,o.unpack(k,b,x),b+=o.packedLength,n.unpack(k,b,v);let I,E=m.length/3,U=m.subarray(0,E),V=m.subarray(E,2*E),j=m.subarray(2*E,3*E);t.zigZagDeltaDecode(U,V,j),function(e,t,r,s){let a=s.length,n=e.length,o=new Uint8Array(n),l=0;for(let r=0;r<a;r++){let a=s[r],n=a;for(let r=1;r<a;r++){let s=l+r,a=s-1;u.longitude=e[s],u.latitude=t[s],c.longitude=e[a],c.latitude=t[a],i.equals(u,c)&&(n--,o[a]=1)}s[r]=n,l+=a}let d=0;for(let s=0;s<n;s++)1!==o[s]&&(e[d]=e[s],t[d]=t[s],r[d]=r[s],d++)}(U,V,j,w);let B=w.length,C=0;for(I=0;I<B;I++)C+=w[I]-1;let W=new p(C),R=function(e,t,r,s,a,o,d){let c=e.length,u=new Float64Array(3*c);for(let p=0;p<c;++p){let c=e[p],m=t[p],A=r[p],w=l.lerp(s.west,s.east,c/32767),N=l.lerp(s.south,s.north,m/32767),k=l.lerp(a,o,A/32767),b=i.fromRadians(w,N,k,f),g=d.cartographicToCartesian(b,h);n.pack(g,u,3*p)}return u}(U,V,j,F,g,y,x,v),T=new Float32Array(3*(E=U.length));for(I=0;I<E;++I)T[3*I]=R[3*I]-v.x,T[3*I+1]=R[3*I+1]-v.y,T[3*I+2]=R[3*I+2]-v.z;let D=0,L=0;for(I=0;I<B;I++){let e=w[I]-1,t=.5*A[I],r=N[I],s=D;for(let a=0;a<e;a++){let i=n.unpack(T,D,P),o=n.unpack(T,D+3,O),d=j[L],f=j[L+1];d=l.lerp(g,y,d/32767),f=l.lerp(g,y,f/32767),L++;let h=H,c=S;if(0===a){let t=s+3*e,r=n.unpack(T,t,H);if(n.equals(r,i))n.unpack(T,t-3,h);else{let e=n.subtract(i,o,H);h=n.add(e,i,H)}}else n.unpack(T,D-3,h);if(a===e-1){let e=n.unpack(T,s,S);if(n.equals(e,o))n.unpack(T,s+3,c);else{let e=n.subtract(o,i,S);c=n.add(e,o,S)}}else n.unpack(T,D+6,c);W.addVolume(h,i,o,c,d,f,t,r,v,x),D+=3}D+=3,L++}let z=W.indices;d.push(W.startEllipsoidNormals.buffer),d.push(W.endEllipsoidNormals.buffer),d.push(W.startPositionAndHeights.buffer),d.push(W.startFaceNormalAndVertexCornerIds.buffer),d.push(W.endPositionAndHeights.buffer),d.push(W.endFaceNormalAndHalfWidths.buffer),d.push(W.vertexBatchIds.buffer),d.push(z.buffer);let q={indexDatatype:2===z.BYTES_PER_ELEMENT?r.UNSIGNED_SHORT:r.UNSIGNED_INT,startEllipsoidNormals:W.startEllipsoidNormals.buffer,endEllipsoidNormals:W.endEllipsoidNormals.buffer,startPositionAndHeights:W.startPositionAndHeights.buffer,startFaceNormalAndVertexCornerIds:W.startFaceNormalAndVertexCornerIds.buffer,endPositionAndHeights:W.endPositionAndHeights.buffer,endFaceNormalAndHalfWidths:W.endFaceNormalAndHalfWidths.buffer,vertexBatchIds:W.vertexBatchIds.buffer,indices:z.buffer};if(e.keepDecodedPositions){let e=function(e){let t=e.length,r=new Uint32Array(t+1),s=0;for(let a=0;a<t;++a)r[a]=s,s+=e[a];return r[t]=s,r}(w);d.push(R.buffer,e.buffer),q=s(q,{decodedPositions:R.buffer,decodedPositionOffsets:e.buffer})}return q});export{U as default};